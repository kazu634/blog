---
title: anything の source を作ってみる (initの使い方)
author: kazu634
date: 1969-12-31
url: /1970/01/01/_0/
wordtwit_post_info:
  - 'O:8:"stdClass":13:{s:6:"manual";b:0;s:11:"tweet_times";i:1;s:5:"delay";i:0;s:7:"enabled";i:1;s:10:"separation";s:2:"60";s:7:"version";s:3:"3.7";s:14:"tweet_template";b:0;s:6:"status";i:2;s:6:"result";a:0:{}s:13:"tweet_counter";i:2;s:13:"tweet_log_ids";a:1:{i:0;i:4879;}s:9:"hash_tags";a:0:{}s:8:"accounts";a:1:{i:0;s:7:"kazu634";}}'
categories:
  - Emacs

---
<div class="section">
<p>
    Anything.el の source で init を使ってみて、うまくいかなかったのでここに書いておきます。
</p>
  
<h4>
    駄目だったソース
</h4>
  
<p>
    init の説明にはこうありました。
</p>
  
<blockquote title="2009-10-12 - 武蔵の日記" cite="http://d.hatena.ne.jp/sirocco634/20091012#1255336649">
<dl>
<dt>
        init (オプション)
</dt>
      
<dd>
        anything が実行された際に引数なしで呼び出される関数。この要素は、候補のリストを作成するために現在の状況を収集するのに便利である。<br />例えば、 source がカレントディレクトリを対象とした場合、init 要素に指定することでカレントディレクトリの情報を収集することができる。なぜならば、それ以降 anything はミニバッファーと anything-buffer で動作し、カレントディレクトリが変わる可能性が出てくるからである。
</dd>
</dl>
    
<p>
<cite><a href="http://d.hatena.ne.jp/sirocco634/20091012#1255336649" onclick="__gaTracker('send', 'event', 'outbound-article', 'http://d.hatena.ne.jp/sirocco634/20091012#1255336649', '2009-10-12 &#8211; 武蔵の日記');" target="_blank">2009-10-12 &#8211; 武蔵の日記</a></cite>
</p>
</blockquote>
  
<p>
    これは candidates を表示する前に実行される関数なのだろうと単純に考えていたのですが、間違えていたようでした。
</p>
  
<p>
    つくってみたソースはこちら:
</p>
  
<pre class="syntax-highlight">
<span class="synSpecial">(</span><span class="synStatement">setq</span> anything-c-source-testtest
<span class="synSpecial">'((</span>name . <span class="synConstant">&#34;test Search&#34;</span><span class="synSpecial">)</span>
<span class="synSpecial">(</span>init .
<span class="synSpecial">(</span><span class="synStatement">lambda</span> <span class="synSpecial">()</span>
<span class="synSpecial">(</span>read-string <span class="synConstant">&#34;?: &#34;</span><span class="synSpecial">)))</span>
<span class="synSpecial">(</span>candidates .
<span class="synSpecial">(</span><span class="synConstant">&#34;foo&#34;</span> <span class="synConstant">&#34;bar&#34;</span><span class="synSpecial">))</span>
<span class="synSpecial">(</span>action . <span class="synSpecial">((</span><span class="synConstant">&#34;Insert&#34;</span> . insert<span class="synSpecial">)))))</span>
</pre>
  
<p>
    これを実行すると、下のような形で候補が表示されるのと、ミニバッファーでの問い合わせが同時に行われてしまいます:
</p>
  
<p>
<center>
</center>
</p>
  
<p>
<a href="http://flickr.com/photos/42332031@N02/4052410201/" onclick="__gaTracker('send', 'event', 'outbound-article', 'http://flickr.com/photos/42332031@N02/4052410201/', '');" title="駄目なsourceの例"><img src="http://farm3.static.flickr.com/2726/4052410201_0eb41915b0.jpg" /></a>
</p></p> 
  
<p>
    スクリプトの引数を入力してもらってから、スクリプトを実施、候補の表示という流れにしたかったのですが、 init ではできないようです。。。
</p>
  
<h4>
    やりたかったことはこうすればできました
</h4>
  
<pre class="syntax-highlight">
<span class="synComment">;; グローバル変数を定義</span>
<span class="synSpecial">(</span><span class="synStatement">defvar</span> anything-c-source-amazon-work <span class="synConstant">&#34;a&#34;</span><span class="synSpecial">)</span>
<span class="synComment">;; 事前にこの関数を呼び出して、引数を取得→anything-c-source-amazon-workに代入</span>
<span class="synComment">;; その後、anything-c-source-amazonでanythingを起動する</span>
<span class="synComment">;; anything-c-source-amazonは、anything-c-source-amazon-workを引数として</span>
<span class="synComment">;; 外部スクリプトを実行し、候補を生成する</span>
<span class="synSpecial">(</span><span class="synStatement">defun</span> anything_amazon <span class="synSpecial">(</span>key<span class="synSpecial">)</span>
<span class="synSpecial">(</span>interactive <span class="synConstant">&#34;sISBN13 or ASIN: &#34;</span><span class="synSpecial">)</span>
<span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span>string-match <span class="synConstant">&#34;[0-9]+&#34;</span> key<span class="synSpecial">)</span>
<span class="synSpecial">(</span><span class="synStatement">progn</span>
<span class="synSpecial">(</span><span class="synStatement">setq</span> anything-c-source-amazon-work key<span class="synSpecial">)</span>
<span class="synSpecial">(</span>anything <span class="synSpecial">'</span><span class="synIdentifier">anything-c-source-amazon</span>
<span class="synStatement">nil</span>
<span class="synConstant">&#34;Title: &#34;</span>
<span class="synStatement">nil</span>
<span class="synStatement">nil</span>
anything-call-source-buffer<span class="synSpecial">))</span>
<span class="synSpecial">(</span>message <span class="synConstant">&#34;Please enter ISBN13 or ASIN!&#34;</span><span class="synSpecial">)))</span>
<span class="synSpecial">(</span><span class="synStatement">defvar</span> anything-c-source-amazon
<span class="synSpecial">'((</span>name . <span class="synConstant">&#34;Amazon Search&#34;</span><span class="synSpecial">)</span>
<span class="synSpecial">(</span>candidates .
<span class="synSpecial">(</span><span class="synStatement">lambda</span> <span class="synSpecial">()</span>
<span class="synSpecial">(</span><span class="synStatement">if</span> <span class="synSpecial">(</span>string-match <span class="synConstant">&#34;[0-9]+&#34;</span> anything-c-source-amazon-work<span class="synSpecial">)</span>
<span class="synSpecial">(</span><span class="synStatement">delete</span> <span class="synConstant">&#34;&#34;</span>
<span class="synSpecial">(</span>split-string
<span class="synSpecial">(</span>shell-command-to-string
<span class="synSpecial">(</span><span class="synStatement">format</span> <span class="synConstant">&#34;access_amazon %s&#34;</span>
anything-c-source-amazon-work<span class="synSpecial">))</span>
<span class="synConstant">&#34;\n&#34;</span><span class="synSpecial">))</span>
<span class="synConstant">&#34;No Results&#34;</span><span class="synSpecial">)))</span>
<span class="synSpecial">(</span>candidate-transformer . <span class="synSpecial">(</span><span class="synStatement">lambda</span> <span class="synSpecial">(</span>candidates<span class="synSpecial">)</span>
<span class="synSpecial">(</span><span class="synStatement">mapcar</span>
<span class="synSpecial">(</span><span class="synStatement">function</span> <span class="synSpecial">(</span><span class="synStatement">lambda</span><span class="synSpecial">(</span>arg<span class="synSpecial">)</span>
<span class="synSpecial">(</span><span class="synStatement">apply</span> '<span class="synStatement">cons</span> <span class="synSpecial">(</span>split-string arg <span class="synConstant">&#34;\t&#34;</span><span class="synSpecial">))))</span>
candidates<span class="synSpecial">)))</span>
<span class="synSpecial">(</span>action . <span class="synSpecial">((</span><span class="synConstant">&#34;Insert&#34;</span> . insert<span class="synSpecial">)))))</span>
</pre>
</div>